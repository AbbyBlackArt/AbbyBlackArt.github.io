---
import { getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import Container from "@components/Container.astro";
import { Image } from "astro:assets";
import Link from "@components/Link.astro";

export async function getStaticPaths() {
  const works = await getCollection("works");
  
  // Get all unique categories from all works
  const allCategories = new Set<string>();
  works.forEach((work) => {
    if (work.data.categories) {
      work.data.categories.forEach((category) => {
        allCategories.add(category);
      });
    }
  });
  
  // Generate paths for each category
  return Array.from(allCategories).map((category) => ({
    params: { slug: category.toLowerCase().replace(/\s+/g, "-") },
    props: { category },
  }));
}

type Props = {
  category: string;
};

const { category } = Astro.props;

const allWorks = await getCollection("works");

// Helper function to get primary image from a work
function getPrimaryImage(work: typeof allWorks[0]) {
  if (!work.data.images || work.data.images.length === 0) return null;
  const sortedImages = [...work.data.images].sort((a, b) => {
    const orderA = a.order ?? Infinity;
    const orderB = b.order ?? Infinity;
    return orderA - orderB;
  });
  return sortedImages[0].file;
}

// Get all works that have this category
const works = allWorks.filter((work) => {
  if (!work.data.categories) return false;
  return work.data.categories.some(
    (cat) => cat.toLowerCase().replace(/\s+/g, "-") === category.toLowerCase().replace(/\s+/g, "-")
  );
});

// Format category name for display (convert slug back to readable format)
const categoryDisplayName = category
  .split("-")
  .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
  .join(" ");
---

<PageLayout title={categoryDisplayName} description={`Images in the ${categoryDisplayName} category`}>
  <Container>
    <div class="animate">
      <Link href="/">‚Üê Back to home</Link>
    </div>
    <h1 class="animate text-2xl font-semibold text-black dark:text-white my-10">
      {categoryDisplayName}
    </h1>
    {works.length === 0 ? (
      <p class="animate">No works found in this category.</p>
    ) : (
      <div class="flex flex-wrap justify-center gap-4 align-items-center">
        {works.map((work) => {
          const primaryImage = getPrimaryImage(work);
          return primaryImage ? (
            <div class="flex justify-center flex-row md:w-2/5">
              <Link href={`/works/${work.slug}`} underline={false}>
                <figure>
                  <Image
                    src={primaryImage}
                    alt={work.data.title}
                    class="max-w-xl w-full h-auto aspect-[4/3] object-cover"
                  />
                  <figcaption class="text-center">
                    <i>{work.data.title}</i>
                    {work.data.summary && `, ${work.data.summary}`}
                  </figcaption>
                </figure>
              </Link>
            </div>
          ) : null;
        })}
      </div>
    )}
  </Container>
</PageLayout>