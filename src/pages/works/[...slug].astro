---
import { type CollectionEntry, getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import Container from "@components/Container.astro";
import FormattedDate from "@components/FormattedDate.astro";
import BackToPrev from "@components/BackToPrev.astro";
import { Image } from "astro:assets";

export async function getStaticPaths() {
  const works = (await getCollection("works"))
    .filter(work => !work.data.draft);
  return works.map((work) => ({
    params: { slug: work.slug },
    props: work,
  }));
}

type Props = CollectionEntry<"works">;

const work = Astro.props;

// Sort images by order if provided, otherwise keep array order
const sortedImages = [...work.data.images].sort((a, b) => {
  const orderA = a.order ?? Infinity;
  const orderB = b.order ?? Infinity;
  return orderA - orderB;
});
---

<PageLayout title={work.data.title} description={work.data.summary || work.data.title}>
  <Container>
    <div class="animate">
      <BackToPrev href="/">
        ‚Üê Back to home
      </BackToPrev>
    </div>
    <div class="space-y-1 my-10">
      {work.data.date && (
        <div class="animate flex items-center gap-1.5">
          <div class="font-base text-sm">
            <FormattedDate date={work.data.date} />
          </div>
        </div>
      )}
      <div class="animate text-2xl font-semibold text-black dark:text-white">
        {work.data.title}
      </div>
      {work.data.summary && (
        <div class="animate text-black/60 dark:text-white/60">
          {work.data.summary}
        </div>
      )}
      {work.data.categories && work.data.categories.length > 0 && (
        <div class="animate flex flex-wrap gap-2 mt-2">
          {work.data.categories.map((category) => (
            <span class="text-xs px-2 py-1 bg-black/10 dark:bg-white/10 rounded">
              {category}
            </span>
          ))}
        </div>
      )}
    </div>
    <div class="animate space-y-8">
      {sortedImages.map((imageData, index) => (
        <figure class="w-full">
          <Image
            src={imageData.file}
            alt={imageData.title || work.data.title}
            class="w-full h-auto"
            loading={index === 0 ? "eager" : "lazy"}
          />
          {(imageData.title || imageData.description) && (
            <figcaption class="text-center mt-2 text-sm text-black/60 dark:text-white/60">
              {imageData.title && <i>{imageData.title}</i>}
              {imageData.title && imageData.description && ", "}
              {imageData.description && imageData.description}
            </figcaption>
          )}
        </figure>
      ))}
    </div>
  </Container>
</PageLayout>

